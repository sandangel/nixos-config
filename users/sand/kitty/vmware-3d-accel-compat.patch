From 06e3b236cd59b4ca1d4f29618fca1f01dcd9a991 Mon Sep 17 00:00:00 2001
From: Loris Cro <kappaloris@gmail.com>
Date: Tue, 17 Jan 2023 13:03:42 +0100
Subject: [PATCH] vmware 3d-accel compat

---
 kitty/screen.c  | 4 ++--
 kitty/shaders.c | 4 ++--
 shell.nix       | 2 ++
 3 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/kitty/screen.c b/kitty/screen.c
index e52dd98f..7e7d0a1f 100644
--- a/kitty/screen.c
+++ b/kitty/screen.c
@@ -2391,12 +2391,12 @@ iteration_data_is_empty(const Screen *self, const IterationData *idata) {
 }

 static void
-apply_selection(Screen *self, uint8_t *data, Selection *s, uint8_t set_mask) {
+apply_selection(Screen *self, uint32_t *data, Selection *s, uint8_t set_mask) {
     iteration_data(self, s, &s->last_rendered, -self->historybuf->count, true);

     for (int y = MAX(0, s->last_rendered.y); y < s->last_rendered.y_limit && y < (int)self->lines; y++) {
         Line *line = visual_line_(self, y);
-        uint8_t *line_start = data + self->columns * y;
+        uint32_t *line_start = data + self->columns * y;
         XRange xr = xrange_for_iteration(&s->last_rendered, y, line);
         for (index_type x = xr.x; x < xr.x_limit; x++) line_start[x] |= set_mask;
     }
diff --git a/kitty/shaders.c b/kitty/shaders.c
index a4ae4e90..ca6634df 100644
--- a/kitty/shaders.c
+++ b/kitty/shaders.c
@@ -233,7 +233,7 @@ create_cell_vao() {
     A1(colors, 3, GL_UNSIGNED_INT, fg);

     add_buffer_to_vao(vao_idx, GL_ARRAY_BUFFER);
-    A(is_selected, 1, GL_UNSIGNED_BYTE, NULL, 0);
+    A(is_selected, 1, GL_UNSIGNED_INT, NULL, 0);

     size_t bufnum = add_buffer_to_vao(vao_idx, GL_UNIFORM_BUFFER);
     alloc_vao_buffer(vao_idx, cell_program_layouts[CELL_PROGRAM].render_data.size, bufnum, GL_STREAM_DRAW);
@@ -399,7 +399,7 @@ cell_prepare_to_render(ssize_t vao_idx, ssize_t gvao_idx, Screen *screen, GLfloa
     }

     if (screen->reload_all_gpu_data || screen_resized || screen_is_selection_dirty(screen)) {
-        sz = (size_t)screen->lines * screen->columns;
+        sz = (size_t)screen->lines * screen->columns * sizeof(uint32_t);
         address = alloc_and_map_vao_buffer(vao_idx, sz, selection_buffer, GL_STREAM_DRAW, GL_WRITE_ONLY);
         screen_apply_selection(screen, address, sz);
         unmap_vao_buffer(vao_idx, selection_buffer); address = NULL;
diff --git a/shell.nix b/shell.nix
index 4e5744fd..5c731ae2 100644
--- a/shell.nix
+++ b/shell.nix
@@ -14,6 +14,7 @@ mkShell rec {
     ncurses
     lcms2
     librsync
+    openssl.dev
   ] ++ optionals stdenv.isDarwin [
     Cocoa
     CoreGraphics
@@ -57,6 +58,7 @@ mkShell rec {
   shellHook = if stdenv.isDarwin then ''
     export KITTY_NO_LTO=
   '' else ''
+    export KITTY_FONTCONFIG_LIBRARY='${fontconfig.lib}/lib/libfontconfig.so'
     export KITTY_EGL_LIBRARY='${lib.getLib libGL}/lib/libEGL.so.1'
     export KITTY_STARTUP_NOTIFICATION_LIBRARY='${libstartup_notification}/lib/libstartup-notification-1.so'
     export KITTY_CANBERRA_LIBRARY='${libcanberra}/lib/libcanberra.so'
--
2.38.1
